<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="favicon.svg" type="image/svg">
    <title>Lamento da Vi√∫va</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="skull">üíÄ</div>
            <h1>Sistema de Metas da Tripula√ß√£o</h1>
            <p>N√£o tem espa√ßo pra pregui√ßoso no nosso conv√©s! üåä</p>
        </div>

        <div class="meta-info">
            <h2>‚öì Metas da Semana</h2>
            <div class="meta-details">
                <div class="meta-card">
                    <h3>üéØ Sistema de Metas</h3>
                    <div class="goals-system">
                        <div class="goal-tier minimum">
                            <strong>üìä Meta M√≠nima: 250 drogas</strong><br>
                            <small>Apenas dinheiro do trabalho</small>
                        </div>
                        <div class="goal-tier premium">
                            <strong>üèÜ Meta Premium: 500+ drogas</strong><br>
                            <small> Ou equivalente em dinheiro sujo<br>
                                <em>(cada droga = $28 sujo)</em></p></small>
                            <strong><small>Ganha premia√ß√£o da semana!</small></strong>
                        </div>
                    </div>
                </div>
                <div class="meta-card">
                    <h3>üè¥‚Äç‚ò†Ô∏è Por que fazemos isso?</h3>
                    <ul>
                        <li>üí∞ Encher o bolso de cada um</li>
                        <li>üè¶ Manter caixa da tripula√ß√£o saud√°vel</li>
                        <li>‚≠ê Quem vende mais, lucra mais!</li>
                        <li>üéÅ Premia√ß√µes para os dedicados!</li>
                    </ul>
                </div>
            </div>
            <div class="premio">
                ‚öîÔ∏è PR√äMIO DESTA SEMANA: UM ABRA√áO DO CAPIT√ÉO BANANINHA para quem bater 500+ drogas!
            </div>
        </div>

        <div class="controls">
            <button class="btn btn-primary" onclick="openUpdateModal()">üìä Atualizar Progresso</button>
            <button class="btn btn-primary" onclick="resetWeek()">üîÑ Nova Semana</button>
            <button class="btn btn-primary" onclick="exportData()">üì§ Exportar Dados</button>
            <button class="btn btn-primary" onclick="triggerImport()">Importar Dados</button>
            <button class="btn btn-primary" onclick="window.location.href='historico.html'">üèÜ Ranking
                Hist√≥rico</button>
            <input type="file" id="fileInput" accept=".json" style="display:none" onchange="importDataFromFile(event)">
        </div>

        <div class="crew-grid" id="crewGrid">
            <!-- Os membros da tripula√ß√£o ser√£o gerados aqui -->
        </div>

        <div class="treasury">
            <h2>üè¥‚Äç‚ò†Ô∏è Caixa da Tripula√ß√£o</h2>
            <div class="treasury-value" id="treasuryValue">$672.00</div>
            <p>Tesouro acumulado da semana</p>
        </div>
    </div>

    <!-- Modal para atualizar progresso -->
    <div id="updateModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeUpdateModal()">&times;</span>
            <h3>‚öì Atualizar Progresso</h3>
            <div class="form-group">
                <label for="memberSelect">Membro da Tripula√ß√£o:</label>
                <select id="memberSelect"></select>
            </div>
            <div class="form-group">
                <label for="drugsInput">Drogas Vendidas:</label>
                <input type="number" id="drugsInput" min="0" placeholder="Digite a quantidade">
            </div>
            <div class="form-group">
                <label for="dirtyMoneyInput">Dinheiro Sujo ($):</label>
                <input type="number" id="dirtyMoneyInput" min="0" step="0.01"
                    placeholder="Ser√° calculado automaticamente">
            </div>
            <button class="btn btn-primary" onclick="updateProgress()" style="width: 100%; margin-top: 20px;">
                üí∞ Atualizar Progresso
            </button>
        </div>
    </div>

    <script>
        // declarada globalmente
        let crewData = {};

        // Carregar dados - primeiro tenta do arquivo JSON, depois do localStorage como fallback
        async function loadCrewData() {
            try {
                const csvUrl = 'https://docs.google.com/spreadsheets/d/1nTtm63rHntqpyVMrdbz8J7o1xKL7RdXdp320k_NlP-I/export?format=csv';
                const response = await fetch(csvUrl);
                if (!response.ok) throw new Error('Erro ao buscar planilha');
                const csvText = await response.text();

                crewData = {};
                const lines = csvText.trim().split('\n');
                const headers = lines[0].split(',');

                for (let i = 1; i < lines.length; i++) {
                    const cols = lines[i].split(',');
                    const name = cols[0];
                    const drugs = parseFloat(cols[1]) || 0;
                    const dirtyMoney = parseFloat(cols[2]) || 0; // Dinheiro sujo da planilha

                    // C√°lculos simplificados
                    const cleanMoneyBeforeContribution = dirtyMoney * 0.8; // Remove 20% da lavagem
                    const contribution = cleanMoneyBeforeContribution * 0.2; // 20% para tripula√ß√£o
                    const finalCleanMoney = cleanMoneyBeforeContribution - contribution; // O que sobra para o indiv√≠duo

                    crewData[name] = {
                        drugs: drugs,
                        dirtyMoney: dirtyMoney,
                        cleanMoney: finalCleanMoney,
                        contribution: contribution
                    };
                }
                renderCrew();
            } catch (error) {
                alert('Erro ao carregar dados da planilha: ' + error.message);
                crewData = {};
                renderCrew();
            }
        }

        // Salvar dados no localStorage E opcionalmente oferecer download do JSON atualizado
        function saveCrewData() {
            // Sempre salva no localStorage
            localStorage.setItem('crewData', JSON.stringify(crewData));

            // Opcional: tamb√©m oferece para salvar o arquivo atualizado
            // Voc√™ pode remover esta parte se n√£o quiser o prompt autom√°tico
            if (confirm('Deseja baixar uma c√≥pia atualizada do arquivo crewData.json?')) {
                exportData();
            }
        }

        const MINIMUM_DRUGS = 250;  // Meta m√≠nima
        const TARGET_DRUGS = 500;   // Meta para premia√ß√£o
        const DRUG_VALUE = 8;
        const WASHING_PERCENT = 20;         // custo para "processar" o bruto
        const CONTRIBUTION_PERCENT = 20; // Porcentagem da contribui√ß√£o (20%)

        function getStatusClass(drugs) {
            if (drugs >= TARGET_DRUGS) return 'completed';
            if (drugs >= MINIMUM_DRUGS) return 'minimum-reached';
            if (drugs > 0) return 'in-progress';
            return 'not-started';
        }

        function getStatusIcon(drugs) {
            if (drugs >= TARGET_DRUGS) return 'üèÜ';
            if (drugs >= MINIMUM_DRUGS) return '‚úÖ';
            if (drugs > 0) return '‚ö°';
            return 'üí§';
        }

        function getStatusBadge(drugs) {
            if (drugs >= TARGET_DRUGS) return '<span class="status-badge premium">üéÅ bateu a meta e ganhou um pr√™mio especial! üéÅüè¥‚Äç‚ò†Ô∏è</span>';
            if (drugs >= MINIMUM_DRUGS) return '<span class="status-badge minimum">‚úÖ META M√çNIMA ATINGIDA</span>';
            return '';
        }

        function formatMoney(amount) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        function renderCrew() {
            const crewGrid = document.getElementById('crewGrid');
            const memberSelect = document.getElementById('memberSelect');

            crewGrid.innerHTML = '';
            memberSelect.innerHTML = '<option value="">Selecione um membro...</option>';

            // Ordenar por progresso (maior primeiro)
            const sortedCrew = Object.entries(crewData).sort((a, b) => b[1].drugs - a[1].drugs);

            sortedCrew.forEach(([name, data]) => {
                // Arredondar apenas as drogas para exibi√ß√£o
                const drugsDisplayed = Math.round(data.drugs);
                const statusClass = getStatusClass(drugsDisplayed);
                const statusIcon = getStatusIcon(drugsDisplayed);
                const statusBadge = getStatusBadge(drugsDisplayed);
                const progressPercent = Math.min((drugsDisplayed / TARGET_DRUGS) * 100, 100);

                const crewMember = document.createElement('div');
                crewMember.className = `crew-member ${statusClass}`;
                crewMember.innerHTML = `
                    <div class="member-name">
                        <span class="status-icon">${statusIcon}</span>
                        ${name}
                        ${statusBadge}
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill ${statusClass}" style="width: ${progressPercent}%"></div>
                        <div class="progress-text">${drugsDisplayed}/${TARGET_DRUGS} drogas (${Math.round(progressPercent)}%)</div>
                    </div>
                    <div class="stats">
                        <div class="stat">
                            <div class="stat-value">${formatMoney(data.dirtyMoney)}</div>
                            <div class="stat-label">Dinheiro Sujo</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value">${formatMoney(data.cleanMoney)}</div>
                            <div class="stat-label">Dinheiro Limpo</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value">${formatMoney(data.contribution)}</div>
                            <div class="stat-label">Contribui√ß√£o</div>
                        </div>
                    </div>
                `;
                crewGrid.appendChild(crewMember);

                // Adicionar ao select
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                memberSelect.appendChild(option);
            });

            // Atualizar caixa da tripula√ß√£o
            const totalContribution = Object.values(crewData).reduce((sum, member) => sum + member.contribution, 0);
            document.getElementById('treasuryValue').textContent = formatMoney(totalContribution);
        }

        function openUpdateModal() {
            document.getElementById('updateModal').style.display = 'block';
            // Limpar campos ao abrir o modal
            document.getElementById('drugsInput').value = '';
            document.getElementById('dirtyMoneyInput').value = '';
            document.getElementById('calculationResult').innerHTML = '';
        }

        function closeUpdateModal() {
            document.getElementById('updateModal').style.display = 'none';
            // Limpar campos
            document.getElementById('memberSelect').value = '';
            document.getElementById('drugsInput').value = '';
            document.getElementById('dirtyMoneyInput').value = '';
            document.getElementById('calculationResult').innerHTML = '';
        }

        // Fun√ß√£o para calcular valores a partir do dinheiro sujo
        function calculateFromMoney(dirtyMoney) {
            const cleanMoneyBeforeContribution = dirtyMoney * 0.8; // Remove 20% da lavagem
            const contribution = cleanMoneyBeforeContribution * 0.2; // 20% para tripula√ß√£o
            const finalCleanMoney = cleanMoneyBeforeContribution - contribution; // O que sobra para o indiv√≠duo

            return {
                drugs: dirtyMoney / DRUG_VALUE,
                dirtyMoney: dirtyMoney,
                cleanMoney: finalCleanMoney,
                contribution: contribution
            };
        }

        // Fun√ß√£o para calcular valores a partir das drogas
        function calculateFromDrugs(drugs) {
            const dirtyMoney = drugs * DRUG_VALUE;
            const cleanMoneyBeforeContribution = dirtyMoney * 0.8; // Remove 20% da lavagem
            const contribution = cleanMoneyBeforeContribution * 0.2; // 20% para tripula√ß√£o
            const finalCleanMoney = cleanMoneyBeforeContribution - contribution; // O que sobra para o indiv√≠duo

            return {
                drugs: drugs,
                dirtyMoney: dirtyMoney,
                cleanMoney: finalCleanMoney,
                contribution: contribution
            };
        }

        // Mostrar os c√°lculos no modal
        function showCalculations(result) {
            const calculationResult = document.getElementById('calculationResult');
            calculationResult.innerHTML = `
                <div class="calculation-details">
                    <h3>Detalhes do C√°lculo:</h3>
                    <p><strong>Drogas:</strong> ${Math.round(result.drugs)} (exibi√ß√£o)</p>
                    <p><strong>Dinheiro Sujo:</strong> ${formatMoney(result.dirtyMoney)}</p>
                    <p><strong>Dinheiro Limpo:</strong> ${formatMoney(result.cleanMoney)}</p>
                    <p><strong>Contribui√ß√£o (${CONTRIBUTION_PERCENT}%):</strong> ${formatMoney(result.contribution)}</p>
                    <p style="color: #888; font-size: 0.9em;"><em>Nota: Drogas s√£o arredondadas apenas para visualiza√ß√£o. Valores de dinheiro s√£o exatos.</em></p>
                </div>
            `;
        }

        // Atualizar o progresso do membro
        function updateProgress() {
            const memberName = document.getElementById('memberSelect').value;
            const drugsInput = document.getElementById('drugsInput').value;
            const moneyInput = document.getElementById('dirtyMoneyInput').value;

            if (!memberName) {
                alert('Selecione um membro da tripula√ß√£o!');
                return;
            }

            let result;
            if (moneyInput) {
                // PRIORITAR c√°lculo a partir do dinheiro se ambos estiverem preenchidos
                const dirtyMoney = parseFloat(moneyInput);
                result = calculateFromMoney(dirtyMoney);
                console.log('Calculando pelo DINHEIRO:', dirtyMoney, '-> resultado:', result);
            } else if (drugsInput) {
                // Calcular a partir das drogas apenas se dinheiro n√£o foi informado
                const drugs = parseFloat(drugsInput);
                result = calculateFromDrugs(drugs);
                console.log('Calculando pelas DROGAS:', drugs, '-> resultado:', result);
            } else {
                alert('Digite a quantidade de drogas ou o valor em dinheiro!');
                return;
            }

            // Se o membro j√° existir, acumula. Sen√£o, cria do zero
            if (!crewData[memberName]) {
                crewData[memberName] = {
                    drugs: 0,
                    dirtyMoney: 0,
                    cleanMoney: 0,
                    contribution: 0
                };
            }

            const oldDrugs = crewData[memberName].drugs;

            // Acumular os valores EXATOS
            crewData[memberName].drugs += result.drugs;
            crewData[memberName].dirtyMoney += result.dirtyMoney;
            crewData[memberName].cleanMoney += result.cleanMoney;
            crewData[memberName].contribution += result.contribution;

            console.log('Dados salvos para', memberName, ':', crewData[memberName]);

            // Salvar no localStorage
            saveCrewData();

            // Re-renderizar
            renderCrew();
            closeUpdateModal();

            // Mostrar mensagens de conquista (usando valor arredondado das drogas)
            const totalDrugsRounded = Math.round(crewData[memberName].drugs);
            const oldDrugsRounded = Math.round(oldDrugs);

            if (oldDrugsRounded < TARGET_DRUGS && totalDrugsRounded >= TARGET_DRUGS) {
                alert(`üèÜ ${memberName} conquistou a meta premium! Ganha o pr√™mio da semana! üéÅüè¥‚Äç‚ò†Ô∏è`);
            } else if (oldDrugsRounded < MINIMUM_DRUGS && totalDrugsRounded >= MINIMUM_DRUGS) {
                alert(`‚úÖ ${memberName} atingiu a meta m√≠nima! Continue assim para ganhar o pr√™mio! üí™`);
            }
        }

        function resetWeek() {
            if (confirm('Tem certeza que deseja resetar os dados para uma nova semana?')) {
                Object.keys(crewData).forEach(name => {
                    crewData[name] = { drugs: 0, dirtyMoney: 0, cleanMoney: 0, contribution: 0 };
                });

                // Salvar dados resetados
                saveCrewData();
                renderCrew();

                alert('üìä Nova semana iniciada! Que os ventos sejam favor√°veis! ‚õµ');
            }
        }

        function exportData() {
            // Criar objeto com todos os dados necess√°rios
            const exportData = {
                crewData: crewData,
                metadata: {
                    exportDate: new Date().toISOString(),
                    minimumDrugs: MINIMUM_DRUGS,
                    targetDrugs: TARGET_DRUGS,
                    drugValue: DRUG_VALUE,
                    totalContribution: Object.values(crewData).reduce((sum, member) => sum + member.contribution, 0)
                }
            };

            // Converter para JSON formatado
            const jsonData = JSON.stringify(exportData, null, 2);

            // Criar blob para download
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            // Criar elemento de download
            const a = document.createElement('a');
            a.href = url;
            a.download = 'crewData.json';
            document.body.appendChild(a);
            a.click();

            // Limpar
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            alert('üìÅ Arquivo crewData.json atualizado e pronto para download!');
        }

        // Atualizar campo de dinheiro sujo automaticamente quando digitar drogas
        document.getElementById('drugsInput').addEventListener('input', function () {
            const drugs = parseFloat(this.value) || 0;
            if (drugs > 0) {
                const result = calculateFromDrugs(drugs);
                document.getElementById('dirtyMoneyInput').value = result.dirtyMoney;
                showCalculations(result);
            } else {
                document.getElementById('dirtyMoneyInput').value = '';
                document.getElementById('calculationResult').innerHTML = '';
            }
        });

        // Atualizar campo de drogas automaticamente quando digitar dinheiro
        document.getElementById('dirtyMoneyInput').addEventListener('input', function () {
            const dirtyMoney = parseFloat(this.value) || 0;
            if (dirtyMoney > 0) {
                const result = calculateFromMoney(dirtyMoney);
                // Mostrar drogas arredondadas no campo, mas manter valor exato internamente
                document.getElementById('drugsInput').value = Math.round(result.drugs);
                showCalculations(result);
            } else {
                document.getElementById('drugsInput').value = '';
                document.getElementById('calculationResult').innerHTML = '';
            }
        });

        // Fechar modal clicando fora
        window.onclick = function (event) {
            const modal = document.getElementById('updateModal');
            if (event.target === modal) {
                closeUpdateModal();
            }
        }

        function importDataFromFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    crewData = importedData.crewData || importedData;
                    saveCrewData();
                    renderCrew();
                    alert('Dados importados com sucesso!');
                } catch (error) {
                    alert('Erro ao importar arquivo: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function triggerImport() {
            document.getElementById('fileInput').click();
        }

        // Inicializar
        loadCrewData();
    </script>
</body>

</html>
